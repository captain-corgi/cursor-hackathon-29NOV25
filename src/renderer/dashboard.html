<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
    <title>AI Usage Monitor - Dashboard</title>
    <link rel="stylesheet" href="./shared/styles.css" />
  </head>
  <body>
    <div id="root">
      <!-- Header -->
      <header class="header">
        <h1>
          <div class="header-icon">$</div>
          AI Usage Monitor
        </h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div class="status-indicator">
            <span class="status-dot" id="status-dot"></span>
            <span id="last-updated">Loading...</span>
          </div>
          <button class="btn btn-secondary btn-icon" onclick="refreshData()" title="Refresh">üîÑ</button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="container">
        <!-- Period Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="setPeriod('daily')" id="tab-daily">Today</button>
          <button class="tab" onclick="setPeriod('weekly')" id="tab-weekly">This Week</button>
          <button class="tab" onclick="setPeriod('monthly')" id="tab-monthly">This Month</button>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="empty-state">
          <div class="empty-state-icon animate-pulse">‚è≥</div>
          <div class="empty-state-title">Loading...</div>
          <div class="empty-state-description">Fetching usage data from providers</div>
        </div>

        <!-- Content (hidden until data loads) -->
        <div id="content" style="display: none;">
          <!-- Stats Grid -->
          <div class="stats-grid animate-fade-in">
            <div class="stat-card">
              <div class="stat-label">Total Cost</div>
              <div class="stat-value cost" id="total-cost">$0.00</div>
              <div class="stat-change" id="entry-count">0 requests</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Tokens</div>
              <div class="stat-value tokens" id="total-tokens">0</div>
              <div class="stat-change" id="input-percent">0% input</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Input Tokens</div>
              <div class="stat-value" id="input-tokens">0</div>
              <div class="stat-change" id="input-cost">~$0.00 estimated</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Output Tokens</div>
              <div class="stat-value" id="output-tokens">0</div>
              <div class="stat-change" id="output-cost">~$0.00 estimated</div>
            </div>
          </div>

          <!-- Provider Breakdown -->
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">Provider Breakdown</h2>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Provider</th>
                    <th>Requests</th>
                    <th>Tokens</th>
                    <th>Cost</th>
                  </tr>
                </thead>
                <tbody id="provider-table">
                  <tr>
                    <td colspan="4" style="text-align: center; color: var(--text-muted);">No data available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- Model Breakdown -->
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">Model Breakdown</h2>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Model</th>
                    <th>Requests</th>
                    <th>Tokens</th>
                    <th>Cost</th>
                  </tr>
                </thead>
                <tbody id="model-table">
                  <tr>
                    <td colspan="4" style="text-align: center; color: var(--text-muted);">No data available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      let currentPeriod = 'daily';
      let usageData = null;

      // Format helpers
      const formatCost = (cost) => `$${(cost || 0).toFixed(2)}`;
      const formatTokens = (tokens) => (tokens || 0).toLocaleString();

      function formatTime(isoString) {
        if (!isoString) return 'Never';
        const date = new Date(isoString);
        const now = new Date();
        const diff = Math.floor((now.getTime() - date.getTime()) / 1000);
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        return `${Math.floor(diff / 3600)}h ago`;
      }

      function setPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${period}`).classList.add('active');
        updateDisplay();
      }

      function updateDisplay() {
        if (!usageData) return;

        const usage = usageData[currentPeriod];
        if (!usage) {
          document.getElementById('content').style.display = 'none';
          document.getElementById('loading-state').innerHTML = `
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No usage data</div>
            <div class="empty-state-description">No AI usage recorded for this period.</div>
          `;
          document.getElementById('loading-state').style.display = 'block';
          return;
        }

        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Update stats
        document.getElementById('total-cost').textContent = formatCost(usage.totalCostUSD);
        document.getElementById('total-tokens').textContent = formatTokens(usage.totalTokens);
        document.getElementById('entry-count').textContent = `${usage.entryCount} requests`;
        document.getElementById('input-tokens').textContent = formatTokens(usage.inputTokens);
        document.getElementById('output-tokens').textContent = formatTokens(usage.outputTokens);
        
        const inputPercent = usage.totalTokens > 0 ? Math.round((usage.inputTokens / usage.totalTokens) * 100) : 0;
        document.getElementById('input-percent').textContent = `${inputPercent}% input`;
        document.getElementById('input-cost').textContent = `~${formatCost(usage.inputTokens * 0.000003)} estimated`;
        document.getElementById('output-cost').textContent = `~${formatCost(usage.outputTokens * 0.000015)} estimated`;

        // Update last updated
        document.getElementById('last-updated').textContent = `Updated ${formatTime(usageData.lastUpdated)}`;

        // Update provider table
        const providerTable = document.getElementById('provider-table');
        if (usage.providerBreakdown && Object.keys(usage.providerBreakdown).length > 0) {
          providerTable.innerHTML = Object.values(usage.providerBreakdown).map(p => `
            <tr>
              <td><span class="provider-badge ${p.providerId === 'claude-code' ? 'claude' : 'cursor'}">${p.providerName}</span></td>
              <td>${p.entryCount}</td>
              <td>${formatTokens(p.totalTokens)}</td>
              <td style="color: var(--accent-success)">${formatCost(p.costUSD)}</td>
            </tr>
          `).join('');
        } else {
          providerTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No provider data</td></tr>';
        }

        // Update model table
        const modelTable = document.getElementById('model-table');
        if (usage.modelBreakdown && Object.keys(usage.modelBreakdown).length > 0) {
          modelTable.innerHTML = Object.values(usage.modelBreakdown)
            .sort((a, b) => b.costUSD - a.costUSD)
            .map(m => `
              <tr>
                <td style="font-family: var(--font-mono); font-size: 0.8rem;">${m.model}</td>
                <td>${m.entryCount}</td>
                <td>${formatTokens(m.totalTokens)}</td>
                <td style="color: var(--accent-success)">${formatCost(m.costUSD)}</td>
              </tr>
            `).join('');
        } else {
          modelTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No model data</td></tr>';
        }
      }

      async function loadData() {
        try {
          if (window.electronAPI) {
            usageData = await window.electronAPI.getUsageData();
            updateDisplay();
          }
        } catch (e) {
          console.error('Error loading data:', e);
        }
      }

      async function refreshData() {
        try {
          if (window.electronAPI) {
            await window.electronAPI.refreshData();
            await loadData();
          }
        } catch (e) {
          console.error('Error refreshing:', e);
        }
      }

      // Initial load
      document.addEventListener('DOMContentLoaded', loadData);

      // Listen for updates
      if (window.electronAPI) {
        window.electronAPI.onUsageUpdated((data) => {
          usageData = data;
          updateDisplay();
        });
      }
    </script>
  </body>
</html>
